<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GhostDrift Audit OS</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel (for JSX/TS compilation in browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Google Fonts (Inter for OS-like feel) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    /* Hide scrollbar for cleaner UI on mobile */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden selection:bg-indigo-100 selection:text-indigo-800">
  <div id="root"></div>

  <script type="text/babel" data-presets="react,typescript">
    const { useMemo, useState, useEffect, useRef } = React;

    // --- Icons (Lucide replacements for standalone HTML) ---
    const IconBase = ({ children, size = 24, className = "", ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const Activity = (p) => <IconBase {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>;
    const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
    const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></IconBase>;
    const Database = (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>;
    const FileText = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
    const Layout = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></IconBase>;
    const ShieldCheck = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></IconBase>;
    const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
    const Menu = (p) => <IconBase {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>;
    const CloseIcon = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
    const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
    const Layers = (p) => <IconBase {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
    const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
    const ArrowUp = (p) => <IconBase {...p}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></IconBase>;

    // ==========================================
    // PART 1: ADIC AUDIT KERNEL (Logic Layer)
    // ==========================================

    // Utilities
    function intervalAdd(a, b) { return { lower: a.lower + b.lower, upper: a.upper + b.upper }; }
    function intervalSub(a, b) { return { lower: a.lower - b.upper, upper: a.upper - b.lower }; }
    function intervalContainsZero(iv) { return iv.lower <= 0 && 0 <= iv.upper; }
    function intervalMarginContainsZero(iv) {
      if (!intervalContainsZero(iv)) return 0;
      return 1 / (1 + Math.max(Math.abs(iv.lower), Math.abs(iv.upper)));
    }
    function marginEq(lhs, rhs) { const d = Math.abs(lhs - rhs); return d === 0 ? 1 : 1 / (1 + d); }
    function marginGe(lhs, rhs) { const d = lhs - rhs; return d <= 0 ? 0 : Math.min(1, d / Math.max(Math.abs(rhs), 1)); }

    function makeFloatInterval(lower, upper) {
      if (Number.isNaN(lower)) return { lower: 0, upper: 0 };
      return lower <= upper ? { lower, upper } : { lower: upper, upper: lower };
    }
    function divFloatInterval(num, den) {
      if (den.lower <= 0) return { lower: 0, upper: 0 };
      const c = [num.lower/den.lower, num.lower/den.upper, num.upper/den.lower, num.upper/den.upper];
      return { lower: Math.min(...c), upper: Math.max(...c) };
    }
    function intervalGeThreshold(iv, th) {
      const ok = iv.lower >= th; return { ok, margin: ok ? marginGe(iv.lower, th) : 0 };
    }

    // Main Kernel Logic
    function buildAdicLedger(scenario) {
      const entries = [];
      let opCounter = 1;
      const pushFromTransactions = (txs, system) => {
        for (const tx of txs) {
          const debitDelta = tx.debitUncertainty ?? 0;
          const creditDelta = tx.creditUncertainty ?? 0;
          entries.push({
            opId: `op${system}${String(opCounter++).padStart(3, '0')}`,
            opType: 'id', side: 'DEBIT', accountCode: tx.debitAccount,
            valueMain: tx.debitAmount, valueLower: tx.debitAmount - debitDelta, valueUpper: tx.debitAmount + debitDelta,
            txId: tx.txId, system,
          });
          entries.push({
            opId: `op${system}${String(opCounter++).padStart(3, '0')}`,
            opType: 'id', side: 'CREDIT', accountCode: tx.creditAccount,
            valueMain: tx.creditAmount, valueLower: tx.creditAmount - creditDelta, valueUpper: tx.creditAmount + creditDelta,
            txId: tx.txId, system,
          });
        }
      };
      pushFromTransactions(scenario.transactionsA, 'A');
      if (scenario.transactionsB) pushFromTransactions(scenario.transactionsB, 'B');
      return entries;
    }

    function sumAmount(entries, filters) {
      return entries.reduce((sum, e) => {
        if (filters?.side && e.side !== filters.side) return sum;
        if (filters?.accountCode && e.accountCode !== filters.accountCode) return sum;
        if (filters?.system && e.system !== filters.system) return sum;
        return sum + e.valueMain;
      }, 0);
    }

    function sumInterval(entries, filters) {
      let lower = 0, upper = 0;
      for (const e of entries) {
        if (filters?.side && e.side !== filters.side) continue;
        if (filters?.accountCode && e.accountCode !== filters.accountCode) continue;
        if (filters?.system && e.system !== filters.system) continue;
        lower += e.valueLower; upper += e.valueUpper;
      }
      return { lower, upper };
    }

    function getConditionTemplates(scenario) {
      const hasSystemB = !!scenario.transactionsB?.length;
      const t = [];
      const fmtNum = (n) => n.toLocaleString();
      const fmtIv = (i) => `[${i.lower}, ${i.upper}]`;
      const fmtPct = (n) => `${n.toFixed(1)}%`;
      const fmtIvPct = (i) => `[${(i.lower*100).toFixed(1)}%, ${(i.upper*100).toFixed(1)}%]`;

      // C1
      t.push({
        condId: 'C1', kind: 'DEBIT_CREDIT_BALANCE', label: 'Debit/Credit Balance Check', severity: 'HIGH',
        description: 'Verify that the total debit matches the total credit exactly in the trial balance.',
        eval: (entries) => {
          const d = sumAmount(entries, { side: 'DEBIT', system: 'A' }), c = sumAmount(entries, { side: 'CREDIT', system: 'A' });
          const related = entries.filter(e => e.system === 'A');
          const ok = d === c;
          const diffVal = d - c;
          return { 
            condId: 'C1', ok, safetyMargin: marginEq(d, c), lhsValue: d, rhsValue: c,
            display: { actual: fmtNum(d), target: fmtNum(c), diff: `${diffVal > 0 ? '+' : ''}${fmtNum(diffVal)}`, formula: "Total Debit − Total Credit" },
            relatedTxIds: [...new Set(related.map(e => e.txId))], relatedOpIds: related.map(e => e.opId) 
          };
        }
      });
      t.push({
        condId: 'C1_INTERVAL', kind: 'DEBIT_CREDIT_BALANCE', label: 'Debit/Credit (Interval)', severity: 'MEDIUM',
        description: 'Verify if 0 is included in the debit/credit difference interval, considering measurement errors (e.g., ±1).',
        eval: (entries) => {
          const d = sumInterval(entries, { side: 'DEBIT', system: 'A' }), c = sumInterval(entries, { side: 'CREDIT', system: 'A' });
          const diff = intervalSub(d, c);
          const related = entries.filter(e => e.system === 'A');
          const ok = intervalContainsZero(diff);
          return { 
            condId: 'C1_INTERVAL', ok, safetyMargin: intervalMarginContainsZero(diff), lhsValue: diff.lower, rhsValue: diff.upper, 
            display: { actual: fmtIv(diff), target: "Contains 0", diff: ok ? "Within Range (OK)" : "Out of Range (NG)", formula: "Diff. Permissible Range" },
            relatedTxIds: [...new Set(related.map(e => e.txId))], relatedOpIds: related.map(e => e.opId) 
          };
        }
      });

      // C2
      t.push({
        condId: 'C2', kind: 'ACCOUNT_ROLLFORWARD', label: 'AR Roll-forward', severity: 'HIGH',
        description: 'Strictly verify "Beginning + Sales(Dr) - Collection(Cr) = Ending" for Accounts Receivable.',
        eval: (entries, sc) => {
          const open = sc.openingBalances['Accounts Receivable'] ?? 0, close = sc.closingBalances['Accounts Receivable'] ?? 0;
          const d = sumAmount(entries, { side: 'DEBIT', accountCode: 'Accounts Receivable', system: 'A' });
          const c = sumAmount(entries, { side: 'CREDIT', accountCode: 'Accounts Receivable', system: 'A' });
          const calc = open + d - c;
          const diffVal = calc - close;
          const related = entries.filter(e => e.accountCode === 'Accounts Receivable' && e.system === 'A');
          return { 
            condId: 'C2', ok: calc === close, safetyMargin: marginEq(calc, close), lhsValue: calc, rhsValue: close, 
            display: { actual: fmtNum(calc), target: fmtNum(close), diff: `${diffVal > 0 ? '+' : ''}${fmtNum(diffVal)}`, formula: "Calc Bal − Book Bal" },
            relatedTxIds: [...new Set(related.map(e => e.txId))], relatedOpIds: related.map(e => e.opId) 
          };
        }
      });
      t.push({
        condId: 'C2_INTERVAL', kind: 'ACCOUNT_ROLLFORWARD', label: 'AR Balance (Interval)', severity: 'MEDIUM',
        description: 'Verify if the calculated AR balance interval is consistent with the closing balance, considering uncertainty.',
        eval: (entries, sc) => {
          const open = sc.openingBalances['Accounts Receivable'] ?? 0, close = sc.closingBalances['Accounts Receivable'] ?? 0;
          const d = sumInterval(entries, { side: 'DEBIT', accountCode: 'Accounts Receivable', system: 'A' });
          const c = sumInterval(entries, { side: 'CREDIT', accountCode: 'Accounts Receivable', system: 'A' });
          const diff = intervalSub(intervalSub(intervalAdd({lower:open, upper:open}, d), c), {lower:close, upper:close});
          const related = entries.filter(e => e.accountCode === 'Accounts Receivable' && e.system === 'A');
          const ok = intervalContainsZero(diff);
          return { 
            condId: 'C2_INTERVAL', ok, safetyMargin: intervalMarginContainsZero(diff), lhsValue: diff.lower, rhsValue: diff.upper, 
            display: { actual: fmtIv(diff), target: "Contains 0", diff: ok ? "Within Range (OK)" : "Out of Range (NG)", formula: "Diff. Permissible Range" },
            relatedTxIds: [...new Set(related.map(e => e.txId))], relatedOpIds: related.map(e => e.opId) 
          };
        }
      });

      // C3
      if (typeof scenario.meta?.totalAssets === 'number') {
        t.push({
          condId: 'C3', kind: 'RATIO_THRESHOLD', label: 'Equity Ratio Health', severity: 'MEDIUM',
          description: 'Health check to see if the equity ratio is above 30%.',
          eval: (_, sc) => {
            const a = sc.meta?.totalAssets ?? 1, e = sc.meta?.totalEquity ?? 0;
            const r = e / a;
            const ok = r >= 0.3;
            const diffVal = 0.3 - r;
            return { 
              condId: 'C3', ok, safetyMargin: marginGe(r, 0.3), lhsValue: r * 100, rhsValue: 30, 
              display: { actual: fmtPct(r * 100), target: "≥ 30.0%", diff: ok ? "Clear" : `${(diffVal*100).toFixed(1)}pt Short`, formula: "Equity ÷ Assets" },
              relatedTxIds: [], relatedOpIds: [] 
            };
          }
        });
        t.push({
          condId: 'C3_INTERVAL', kind: 'RATIO_THRESHOLD', label: 'Equity Ratio (Interval)', severity: 'MEDIUM',
          description: 'Treat assets/equity as ranges and verify if the worst-case ratio is still ≥ 30%.',
          eval: (_, sc) => {
            const m = sc.meta || {};
            const aIv = makeFloatInterval(m.totalAssetsLower ?? m.totalAssets ?? 0, m.totalAssetsUpper ?? m.totalAssets ?? 0);
            const eIv = makeFloatInterval(m.totalEquityLower ?? m.totalEquity ?? 0, m.totalEquityUpper ?? m.totalEquity ?? 0);
            if (aIv.lower <= 0) return { condId: 'C3_INTERVAL', ok: false, safetyMargin: 0, lhsValue: 0, rhsValue: 30, display: {actual:'-', target:'-', diff:'-'}, relatedTxIds: [], relatedOpIds: [] };
            const rIv = divFloatInterval(eIv, aIv);
            const { ok, margin } = intervalGeThreshold(rIv, 0.3);
            return { 
              condId: 'C3_INTERVAL', ok, safetyMargin: margin, lhsValue: rIv.lower * 100, rhsValue: 30, 
              display: { actual: fmtIvPct(rIv), target: "≥ 30.0%", diff: ok ? "Clear" : `Below Lower Bound`, formula: "Equity Range ÷ Assets Range" },
              relatedTxIds: [], relatedOpIds: [] 
            };
          }
        });
      }

      // C4
      if (hasSystemB) {
        t.push({
          condId: 'C4', kind: 'CROSS_SYSTEM_BALANCE', label: 'Cross-System Rec.', severity: 'HIGH',
          description: 'Verify accounts receivable balance matches between HQ (A) and Subsidiary (B).',
          eval: (entries) => {
            const getBal = (s) => sumAmount(entries, {side:'DEBIT', accountCode:'Accounts Receivable', system:s}) - sumAmount(entries, {side:'CREDIT', accountCode:'Accounts Receivable', system:s});
            const balA = getBal('A'), balB = getBal('B');
            const related = entries.filter(e => e.accountCode === 'Accounts Receivable');
            const ok = balA === balB;
            const diffVal = balA - balB;
            return { 
              condId: 'C4', ok, safetyMargin: marginEq(balA, balB), lhsValue: balA, rhsValue: balB, 
              display: { actual: fmtNum(balA), target: fmtNum(balB), diff: `${diffVal > 0 ? '+' : ''}${fmtNum(diffVal)}`, formula: "System A − System B" },
              relatedTxIds: [...new Set(related.map(e => e.txId))], relatedOpIds: related.map(e => e.opId) 
            };
          }
        });
        t.push({
          condId: 'C4_INTERVAL', kind: 'CROSS_SYSTEM_BALANCE', label: 'Cross-System (Interval)', severity: 'MEDIUM',
          description: 'Verify if the balance difference interval between System A/B contains 0 (allowing ±1 band).',
          eval: (entries) => {
            const getBalIv = (s) => intervalSub(sumInterval(entries, {side:'DEBIT', accountCode:'Accounts Receivable', system:s}), sumInterval(entries, {side:'CREDIT', accountCode:'Accounts Receivable', system:s}));
            const diff = intervalSub(getBalIv('A'), getBalIv('B'));
            const related = entries.filter(e => e.accountCode === 'Accounts Receivable');
            const ok = intervalContainsZero(diff);
            return { 
              condId: 'C4_INTERVAL', ok, safetyMargin: intervalMarginContainsZero(diff), lhsValue: diff.lower, rhsValue: diff.upper, 
              display: { actual: fmtIv(diff), target: "Contains 0", diff: ok ? "Within Range (OK)" : "Out of Range (NG)", formula: "Diff. Permissible Range" },
              relatedTxIds: [...new Set(related.map(e => e.txId))], relatedOpIds: related.map(e => e.opId) 
            };
          }
        });
      }
      return t;
    }

    function verifyAllConditions(entries, scenario, templates) {
      const ts = templates ?? getConditionTemplates(scenario);
      const results = ts.map(t => t.eval(entries, scenario));
      const allOk = results.every(r => r.ok);
      const minSafetyMargin = results.length === 0 ? 1 : results.reduce((acc, r) => Math.min(acc, r.safetyMargin), 1);
      return { allOk, minSafetyMargin, results };
    }
    
    function exportLedgerAsJson(entries) { return JSON.stringify(entries, null, 2); }

    // ==========================================
    // PART 2: UI LAYER (React Component)
    // ==========================================

    const baseTransactionsA = [
      { txId: 'TX1', date: '2024-03-01', debitAccount: 'Accounts Receivable', debitAmount: 100000, creditAccount: 'Sales', creditAmount: 100000, memo: 'Credit Sales' },
      { txId: 'TX2', date: '2024-03-15', debitAccount: 'Cash', debitAmount: 40000, creditAccount: 'Accounts Receivable', creditAmount: 40000, memo: 'Collection' },
      { txId: 'TX3', date: '2024-03-31', debitAccount: 'Expense', debitAmount: 20000, creditAccount: 'Cash', creditAmount: 20000, memo: 'Payment' },
    ];

    const scenarios = [
      { id: 'normal', name: 'Normal: No Issues', description: 'Normal case where all checks pass.', transactionsA: baseTransactionsA, openingBalances: { 'Accounts Receivable': 0 }, closingBalances: { 'Accounts Receivable': 60000 }, meta: { totalAssets: 200000, totalEquity: 80000 } },
      { id: 'scenarioA', name: 'Case A: 1 Unit Mismatch', description: 'TX2 Credit is 1 unit higher (with ±1 band uncertainty).', transactionsA: [baseTransactionsA[0], { ...baseTransactionsA[1], creditAmount: 40001, creditUncertainty: 1, memo: 'Collection (Error / ±1 band)' }, baseTransactionsA[2]], openingBalances: { 'Accounts Receivable': 0 }, closingBalances: { 'Accounts Receivable': 60000 }, meta: { totalAssets: 200000, totalEquity: 80000 } },
      { id: 'scenarioB', name: 'Case B: AR Bal Mismatch', description: 'Reported closing balance is incorrect.', transactionsA: baseTransactionsA, openingBalances: { 'Accounts Receivable': 0 }, closingBalances: { 'Accounts Receivable': 59000 }, meta: { totalAssets: 200000, totalEquity: 80000 } },
      { id: 'scenarioC', name: 'Case C: Cross-System Diff', description: 'Subsidiary system (B) has discrepant data.', transactionsA: baseTransactionsA, transactionsB: [baseTransactionsA[0], { ...baseTransactionsA[1], debitAmount: 35000, creditAmount: 35000, memo: 'Collection (SysB)' }, baseTransactionsA[2]], openingBalances: { 'Accounts Receivable': 0 }, closingBalances: { 'Accounts Receivable': 60000 }, meta: { totalAssets: 200000, totalEquity: 80000 } },
    ];
    const scenarioById = scenarios.reduce((acc, s) => ({ ...acc, [s.id]: s }), {});

    function AdicAuditDemo() {
      const [scenarioId, setScenarioId] = useState('scenarioA');
      const [selectedTxId, setSelectedTxId] = useState(null);
      const [selectedCondId, setSelectedCondId] = useState('C1');
      const [activeSystemTab, setActiveSystemTab] = useState('A');
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

      const transactionsRef = useRef(null);
      const explorerRef = useRef(null);

      const scenario = scenarioById[scenarioId];
      const adicEntries = useMemo(() => buildAdicLedger(scenario), [scenario]);
      const templates = useMemo(() => getConditionTemplates(scenario), [scenario]);
      const { allOk, minSafetyMargin, results } = useMemo(() => verifyAllConditions(adicEntries, scenario, templates), [adicEntries, scenario, templates]);
      
      const intervalResults = useMemo(() => results.filter(r => r.condId.endsWith('_INTERVAL')), [results]);
      const intervalAllOk = intervalResults.length === 0 ? true : intervalResults.every(r => r.ok);
      const intervalMinMargin = intervalResults.length === 0 ? 1 : intervalResults.reduce((acc, r) => Math.min(acc, r.safetyMargin), 1);
      
      const resultsById = useMemo(() => results.reduce((acc, r) => ({ ...acc, [r.condId]: r }), {}), [results]);
      const templateById = useMemo(() => templates.reduce((acc, t) => ({ ...acc, [t.condId]: t }), {}), [templates]);

      const activeResult = selectedCondId ? resultsById[selectedCondId] : null;
      const highlights = useMemo(() => {
        const tx = new Set(); const op = new Set();
        if (activeResult) { activeResult.relatedTxIds.forEach(id => tx.add(id)); activeResult.relatedOpIds.forEach(id => op.add(id)); }
        if (selectedTxId) { tx.add(selectedTxId); adicEntries.filter(e => e.txId === selectedTxId).forEach(e => op.add(e.opId)); }
        return { tx, op };
      }, [activeResult, selectedTxId, adicEntries]);

      useEffect(() => { setActiveSystemTab('A'); }, [scenarioId]);

      const handleCondClick = (id) => { 
        setSelectedCondId(id); 
        setSelectedTxId(null);
        if (window.innerWidth < 768 && explorerRef.current) {
          setTimeout(() => { explorerRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
        }
      };

      const handleExport = () => {
        const json = exportLedgerAsJson(adicEntries);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `adic-ledger-${scenario.id}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      };

      const handleScrollToTransactions = () => {
        if (transactionsRef.current) transactionsRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
      };

      const activeTransactions = activeSystemTab === 'A' ? scenario.transactionsA : (scenario.transactionsB || []);
      const hasSystemB = !!scenario.transactionsB && scenario.transactionsB.length > 0;

      return (
        <div className="flex flex-col h-screen bg-slate-100 text-slate-800 font-sans overflow-hidden">
          {/* Header */}
          <header className="bg-white border-b shadow-sm flex-shrink-0 z-30 relative">
            <div className="px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="bg-slate-900 text-white p-2 rounded-md"><Activity size={24} /></div>
                <div className="hidden sm:block">
                  <div className="flex items-center gap-2">
                    <h1 className="text-lg font-bold">GhostDrift Audit OS</h1>
                    <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 rounded border">v1.0 (Σ₁/Interval)</span>
                  </div>
                  <p className="text-xs text-slate-500">Automated Audit for Debits/Credits, Roll-forwards & Cross-System Rec.</p>
                </div>
                <div className="sm:hidden font-bold">Audit OS <span className="text-xs font-normal text-slate-500">v1.0</span></div>
              </div>
              
              <div className="flex items-center gap-2">
                <div className="hidden md:flex flex-col items-end gap-1 mr-4">
                  <div className={`flex items-center gap-1 text-[10px] px-2 py-0.5 rounded-full border ${allOk ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-rose-50 border-rose-200 text-rose-700'}`}>
                    <ShieldCheck size={12} /> <span>Strict Audit (Σ₁): {allOk ? 'PASS' : 'FAIL'}</span>
                  </div>
                  <div className={`flex items-center gap-1 text-[10px] px-2 py-0.5 rounded-full border ${intervalAllOk ? 'bg-sky-50 border-sky-200 text-sky-700' : 'bg-amber-50 border-amber-200 text-amber-700'}`}>
                    <Database size={12} /> <span>Interval Audit: {intervalAllOk ? 'PASS' : 'CHECK'}</span>
                  </div>
                </div>
                
                <button className="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>
                  {isMobileMenuOpen ? <CloseIcon size={24} /> : <Menu size={24} />}
                </button>
              </div>
            </div>

            {isMobileMenuOpen && (
              <div className="absolute top-full left-0 w-full bg-white border-b shadow-lg p-4 flex flex-col gap-4 md:hidden z-40">
                <div className="bg-slate-50 p-3 rounded text-xs text-slate-600 space-y-1">
                  <div className="font-bold text-slate-800 mb-2">System Status</div>
                  <div className="flex justify-between items-center">
                    <span>Strict Audit (Σ₁)</span>
                    <span className={`font-mono font-bold ${allOk ? 'text-emerald-600' : 'text-rose-600'}`}>{allOk ? 'PASS' : 'FAIL'}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span>Interval Audit</span>
                    <span className={`font-mono font-bold ${intervalAllOk ? 'text-sky-600' : 'text-amber-600'}`}>{intervalAllOk ? 'PASS' : 'WARN'}</span>
                  </div>
                </div>
                <div>
                  <label className="text-[10px] uppercase font-bold text-slate-400">Select Case</label>
                  <select 
                    className="w-full mt-1 bg-slate-100 border-none rounded p-2 text-sm"
                    value={scenarioId}
                    onChange={(e) => {
                      setScenarioId(e.target.value);
                      setSelectedCondId('C1'); setSelectedTxId(null); setIsMobileMenuOpen(false);
                    }}
                  >
                    {scenarios.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                  </select>
                </div>
              </div>
            )}
          </header>

          <div className="flex-1 overflow-y-auto md:overflow-hidden p-2 md:p-4">
            <div className="flex flex-col md:grid md:grid-cols-12 md:grid-rows-[auto_45%_1fr] gap-3 md:gap-4 md:h-full">
              
              {/* Top Controls Bar (Desktop) */}
              <div className="hidden md:flex md:col-span-12 items-center justify-between bg-white p-2 rounded border shadow-sm shrink-0">
                 <div className="text-xs text-slate-500 flex gap-2 items-center">
                   <span className="font-bold bg-slate-100 px-2 py-0.5 rounded">STEP 1</span>
                   <span>Select a scenario to audit</span>
                 </div>
                 <select 
                   className="text-sm bg-slate-50 border border-slate-200 rounded px-3 py-1 font-medium focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer min-w-[300px]"
                   value={scenarioId}
                   onChange={(e) => {
                     setScenarioId(e.target.value);
                     setSelectedCondId('C1'); setSelectedTxId(null);
                   }}
                 >
                   {scenarios.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                 </select>
              </div>

              {/* Panel 1: Transactions */}
              <div ref={transactionsRef} className="md:col-span-5 md:row-start-2 bg-white rounded-lg border shadow-sm flex flex-col h-[350px] md:h-full overflow-hidden scroll-mt-20">
                <div className="px-3 py-2 border-b bg-slate-50 flex justify-between items-center shrink-0">
                   <div className="flex items-center gap-2 text-slate-700 font-semibold text-xs">
                      <FileText size={14} /> <span>1. Transaction Data</span>
                   </div>
                   {hasSystemB && (
                     <div className="flex bg-slate-200 rounded p-0.5 text-[10px]">
                       <button onClick={() => setActiveSystemTab('A')} className={`px-3 py-1.5 rounded ${activeSystemTab==='A' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500'}`}>System A</button>
                       <button onClick={() => setActiveSystemTab('B')} className={`px-3 py-1.5 rounded ${activeSystemTab==='B' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500'}`}>System B</button>
                     </div>
                   )}
                   {!hasSystemB && <span className="text-[10px] bg-slate-200 px-1.5 rounded text-slate-600">{activeTransactions.length} items</span>}
                </div>
                <div className="flex-1 overflow-auto bg-white relative">
                  <table className="w-full text-xs text-left whitespace-nowrap">
                    <thead className="bg-slate-50 text-slate-500 sticky top-0 z-10 shadow-sm ring-1 ring-black/5">
                      <tr>
                        <th className="px-3 py-2 bg-slate-50">TxID</th>
                        <th className="px-3 py-2 bg-slate-50">Debit</th>
                        <th className="px-3 py-2 text-right bg-slate-50">Amount</th>
                        <th className="px-3 py-2 bg-slate-50">Credit</th>
                        <th className="px-3 py-2 text-right bg-slate-50">Amount</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y">
                      {activeTransactions.length === 0 ? (
                        <tr><td colSpan={5} className="p-4 text-center text-slate-400">No Data</td></tr>
                      ) : activeTransactions.map(tx => {
                        const isHighlighted = highlights.tx.has(tx.txId);
                        return (
                          <tr key={tx.txId} onClick={() => setSelectedTxId(tx.txId === selectedTxId ? null : tx.txId)}
                              className={`cursor-pointer transition-colors ${isHighlighted ? 'bg-amber-100 hover:bg-amber-200' : 'hover:bg-slate-50'}`}>
                            <td className="px-3 py-2 font-mono text-slate-600 font-bold">{tx.txId}</td>
                            <td className="px-3 py-2">{tx.debitAccount}</td>
                            <td className="px-3 py-2 text-right font-mono">{tx.debitAmount.toLocaleString()}</td>
                            <td className="px-3 py-2">{tx.creditAccount}</td>
                            <td className="px-3 py-2 text-right font-mono">{tx.creditAmount.toLocaleString()}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Panel 2: Ledger */}
              <div className="md:col-span-7 md:row-start-2 bg-white rounded-lg border shadow-sm flex flex-col h-[350px] md:h-full overflow-hidden">
                <div className="px-3 py-2 border-b bg-slate-50 flex justify-between items-center shrink-0">
                   <div className="flex items-center gap-2 text-slate-700 font-semibold text-xs">
                      <Database size={14} /> <span>2. ADIC Ledger (Integer Log)</span>
                   </div>
                   <button onClick={handleExport} className="flex items-center gap-1 text-[10px] px-3 py-1 border rounded bg-white hover:bg-slate-50 text-slate-600">
                     <Download size={12} /> <span>JSON</span>
                   </button>
                </div>
                <div className="flex-1 overflow-auto bg-white">
                  <table className="w-full text-xs text-left whitespace-nowrap">
                    <thead className="bg-slate-50 text-slate-500 sticky top-0 z-10 shadow-sm ring-1 ring-black/5">
                      <tr>
                        <th className="px-3 py-2 bg-slate-50">OpID</th>
                        <th className="px-3 py-2 bg-slate-50">Sys</th>
                        <th className="px-3 py-2 bg-slate-50">Side</th>
                        <th className="px-3 py-2 bg-slate-50">Account</th>
                        <th className="px-3 py-2 text-right bg-slate-50">Value</th>
                        <th className="px-3 py-2 text-right text-slate-400 bg-slate-50">Interval [L, U]</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y font-mono">
                      {adicEntries.map(e => (
                        <tr key={e.opId} className={`transition-colors ${highlights.op.has(e.opId) ? 'bg-amber-100' : 'hover:bg-slate-50'}`}>
                          <td className="px-3 py-1.5 text-slate-500">{e.opId}</td>
                          <td className="px-3 py-1.5 text-center"><span className={`px-1 rounded text-[10px] ${e.system === 'A' ? 'bg-slate-200' : 'bg-purple-100 text-purple-700'}`}>{e.system}</span></td>
                          <td className="px-3 py-1.5"><span className={`text-[10px] px-1 rounded ${e.side === 'DEBIT' ? 'text-emerald-700 bg-emerald-50' : 'text-orange-700 bg-orange-50'}`}>{e.side === 'DEBIT'?'Dr':'Cr'}</span></td>
                          <td className="px-3 py-1.5 font-sans">{e.accountCode}</td>
                          <td className="px-3 py-1.5 text-right font-bold text-slate-700">{e.valueMain.toLocaleString()}</td>
                          <td className="px-3 py-1.5 text-right text-slate-400 text-[10px]">[{e.valueLower},{e.valueUpper}]</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Panel 3: Conditions */}
              <div className="md:col-span-7 md:row-start-3 bg-white rounded-lg border shadow-sm flex flex-col h-[350px] md:h-full overflow-hidden">
                <div className="px-3 py-2 border-b bg-slate-50 flex justify-between items-center shrink-0">
                   <div className="flex items-center gap-2 text-slate-700 font-semibold text-xs">
                      <Layout size={14} /> <span>3. Audit Checklist</span>
                   </div>
                   <div className="flex gap-2 text-[10px]">
                     <span className="text-emerald-600 font-bold">PASS: {results.filter(r=>r.ok).length}</span>
                     <span className="text-rose-600 font-bold">FAIL: {results.filter(r=>!r.ok).length}</span>
                   </div>
                </div>
                <div className="flex-1 overflow-auto p-2 space-y-2 bg-slate-50/50">
                  {results.map(r => {
                    const tpl = templateById[r.condId];
                    const isSelected = selectedCondId === r.condId;
                    const isInterval = r.condId.endsWith('_INTERVAL');
                    const barColor = r.ok 
                      ? (isInterval ? 'bg-sky-400' : (r.safetyMargin > 0.8 ? 'bg-emerald-500' : 'bg-yellow-400'))
                      : (isInterval ? 'bg-amber-500' : 'bg-rose-500');
                    
                    return (
                      <div key={r.condId} onClick={() => handleCondClick(r.condId)}
                        className={`
                          border rounded-md p-2 cursor-pointer transition-all relative
                          ${isSelected ? 'ring-2 ring-indigo-500 border-indigo-500 bg-white shadow-md z-10' : 'hover:border-indigo-300 bg-white shadow-sm'}
                          ${isInterval ? 'ml-4 border-l-4 border-l-slate-200' : ''} 
                        `}>
                        {isInterval && <div className="absolute -left-4 top-1/2 w-4 h-px bg-slate-200 -z-10 md:block hidden"></div>}
                        <div className="flex items-center justify-between mb-1">
                          <div className="flex items-center gap-2 overflow-hidden">
                            <div className={`w-5 h-5 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] font-bold ${r.ok ? (isInterval?'bg-sky-100 text-sky-700':'bg-emerald-100 text-emerald-700') : (isInterval?'bg-amber-100 text-amber-700':'bg-rose-100 text-rose-700')}`}>
                              {r.ok ? '✓' : '!'}
                            </div>
                            <span className={`text-xs font-bold truncate ${isInterval ? 'text-slate-600' : 'text-slate-800'}`}>{tpl.label}</span>
                          </div>
                          <div className="text-[10px] font-mono text-slate-400 whitespace-nowrap">Margin: {(r.safetyMargin*100).toFixed(0)}%</div>
                        </div>
                        <div className="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden mb-1"><div className={`h-full ${barColor}`} style={{ width: `${r.safetyMargin * 100}%` }}></div></div>
                        {isSelected && (
                          <div className="mt-2 pt-2 border-t border-slate-100 text-xs text-slate-600">
                            <div className="bg-slate-50 p-2 rounded border border-slate-200 font-mono text-[10px] grid grid-cols-2 gap-2">
                              <div><div className="text-slate-400 uppercase text-[9px]">Actual</div><div className="font-bold text-sm">{r.display.actual}</div></div>
                              <div><div className="text-slate-400 uppercase text-[9px]">Target</div><div className="font-bold text-sm">{r.display.target}</div></div>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Panel 4: Explorer */}
              <div ref={explorerRef} className="md:col-span-5 md:row-start-3 bg-white rounded-lg border shadow-sm flex flex-col h-[350px] md:h-full overflow-hidden scroll-mt-20">
                <div className="px-3 py-2 border-b bg-slate-50 flex justify-between items-center shrink-0">
                   <div className="flex items-center gap-2 text-slate-700 font-semibold text-xs">
                      <Search size={14} /> <span>4. Anomaly Explorer</span>
                   </div>
                </div>
                <div className="flex-1 bg-slate-50 overflow-auto p-4 flex flex-col items-center justify-center">
                  {activeResult && !activeResult.ok ? (
                    <div className="w-full max-w-sm flex flex-col animate-in fade-in zoom-in duration-300">
                       <div className="bg-white p-4 rounded-lg border border-rose-200 shadow-md mb-3">
                          <div className="flex items-center gap-2 text-rose-600 font-bold mb-2 text-sm">
                            <AlertTriangle size={18} /> <span>Inconsistency Detected</span>
                          </div>
                          <div className="text-xs text-slate-600 mb-3 leading-relaxed">{templateById[activeResult.condId].description}</div>
                          {activeResult.display.formula && <div className="text-center text-[10px] text-slate-400 mb-1 font-mono">{activeResult.display.formula}</div>}
                          <div className="bg-rose-50 border border-rose-100 rounded p-3 text-center">
                             <div className="flex justify-center items-baseline gap-2 mb-1">
                               <span className="text-lg font-bold text-slate-700">{activeResult.display.actual}</span>
                               <span className="text-xs text-slate-400">vs</span>
                               <span className="text-lg font-bold text-slate-700">{activeResult.display.target}</span>
                             </div>
                             <div className="border-t border-rose-200 my-1"></div>
                             <div className="text-xs text-slate-500 mb-1 mt-2">Difference</div>
                             <div className="text-xl text-rose-700 font-mono font-bold">{activeResult.display.diff}</div>
                          </div>
                       </div>
                       <div className="text-center text-xs text-slate-600 bg-white p-3 rounded border border-indigo-100 shadow-sm flex flex-col gap-2">
                          <p className="flex items-center justify-center gap-1"><span className="bg-amber-100 text-amber-800 px-1.5 rounded font-bold">Orange</span> <span>rows indicate the cause.</span></p>
                          <button onClick={handleScrollToTransactions} className="flex items-center justify-center gap-1 text-indigo-600 hover:text-indigo-800 font-medium py-2 px-4 rounded-full bg-indigo-50 hover:bg-indigo-100 transition-colors mx-auto border border-indigo-200 active:scale-95">
                            <ArrowUp size={16} /> <span>Jump to Transaction</span>
                          </button>
                          {activeResult.condId.includes('C4') && <p className="text-indigo-600 font-medium mt-1 flex items-start gap-1 justify-center bg-indigo-50/50 p-2 rounded"><Info size={14} className="mt-0.5 shrink-0" /><span>Switch System A/B tabs to compare</span></p>}
                       </div>
                    </div>
                  ) : activeResult?.ok ? (
                    <div className="text-center text-slate-400 animate-in fade-in duration-300">
                      <CheckCircle size={48} className={`mx-auto mb-3 ${activeResult.condId.endsWith('_INTERVAL') ? 'text-sky-200' : 'text-emerald-200'}`} />
                      <p className={`text-base font-bold ${activeResult.condId.endsWith('_INTERVAL') ? 'text-sky-600' : 'text-emerald-600'}`}>Check OK</p>
                      <p className="text-xs mt-1 text-slate-500">All validation conditions met.</p>
                    </div>
                  ) : (
                    <div className="text-center text-slate-400">
                      <Layers size={48} className="mx-auto mb-3 opacity-20" />
                      <p className="text-sm font-medium text-slate-500">Select a Condition</p>
                      <p className="text-xs mt-1">See details from the list on the left</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AdicAuditDemo />);
  </script>
</body>
</html>